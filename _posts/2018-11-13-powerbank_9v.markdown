---
layout: post
title:  'Powerbank 9v для гитарных педалей'
date:   2018-11-13 14:30:21
categories: schematics
---
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
		<center>
          <div class="modal-body">               
          </div>
		</center>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

<div class="thumbnails">
</div>

Как-то мне в руки попали аккумуляторы 18650 из аккумуляторной батареи ноутбука. Контроллер решил, что одна банка сдохла и всё заблокировал. Чтобы не мучиться просто купили новую батарею, а старую я распотрошил.   Посаженной банке я дал волшебный пендель постоянкой, с малым током, подняв её напряжение до трёх с копейками вольт.  
И тут мне пришла идея сделать из этих аккумуляторов повербанк для гитарных педалей. Идея огонь: не нужна розетка, весит меньше, чем трансформатор, фона нет - красота! Осталось только поставить ТЗ.  

### Концепт

* Питание от аккумуляторов - в этом весь смысл.  
* Выход 9 вольт, током... 200-300 мА, например. Не будем туда пихать много педалек на один вход. Самая прожорливая педалька у меня - Electro-Harmonix #1 Echo Digital Delay с добавлением микроконтроллера, дисплея 16x2 и пр. Собственно, сам дисплей и жрёт.  
* Мы делаем всё хорошо, поэтому нужны изолированные выходы.  
* И раз уж у нас аккумуляторы, то надо сделать защиту и зарядку.  
* Зарядка не от USB, а от внешнего источника питания со стандартным штекером
* (дополнительно) Работа устройства во время зарядки

### Подробности

#### Повышающий преобразователь
Первый пункт можно пропустить и перейти сразу ко второму.  
У нас есть грубо говоря 3.7 вольт, из которых надо получить 9 вольт. С этим справится повышающий преобразователь.  
Есть такая "народная" платка, MT3608, на одноимённой микросхеме. Она переваривает как раз напряжение от 2 вольт, выдавая 28 вольт на выходе с током 2 ампера (но это не точно), работает на частоте 1.2 МГц.  
Были закуплены за грошь-цену в количестве 10 штук. Цепляем на выход электролит на 1000 мкФ, отстраиваем 9 вольт и пробуем запитать педальку - работает. Теперь втыкаем перегруз, запитанный с преобразователя, в усилок - фона и треска нет.  

#### Изоляция
Для изоляции я сначала думал сделать какой-нибудь зверь-преобразователь и морально готовился мотать трансформатор на большом кольце (и даже на маленьком), но вовремя узнал про продукцию Mornsun. Они делают DC/DC преобразователи разной мощности - от 1 Вт до 60 Вт и больше. По данным тока в 300 мА мы получаем мощность 2.7 Вт. Значит, ищем преобразователь на 3 ватта. Сами преобразователи представляют из себя трансформатор с минимум обвязки, залитый в компаунд. У него определённое входное и выходное напряжения.  
Варианты такие:  
* 3.7 В -> 9 В -> изоляция 9В  
* 3.7 В -> 5 В -> изоляция 9В  

Этому соответствуют преобразователи B0509 и B0509. Первый на 3 Вт я не нашёл, зато второй обнаружил на одном известном китайском сайте - там вообще целый магазин (якобы) Mornsun'овских преобразователей. Таким образом надо настроить MT3608 на 5 вольт, а после неё поставить B0509S-3WR2 - именно такой корпус мне и нужен. Эксперименты показали, что напряжение чуть завышено, 9.5 вольт. Это не страшно, обычный блок питания на 9 вольт без линейного стабилизатора выдаёт 9 * корень_из_2 = 12,72 вольт. Обычно производители берут это во внимание. С преобразователем никаких проблем не возникло, фона/помех нет, ток, который потребляем Delay выдаёт.  

#### Аккумуляторы
Вернёмся к зачинщикам данной идеи.  
Во-первых, им нужна защита. Я просто купил маленькие платки и напаял их прямо на аккумуляторы. Там всё было в комплекте: плата защиты, пластиковый кожух для неё, листовые контакты для подсоединения к аккумуляторам (сразу припаяны к плате), термоусадка всей банки. Вообще, эти контакты надо приваривать точечной сваркой, но за неимением таковой, пришлось паять. Это надо делать очень осторожно, минимизируя время контакта, так как от нагрева аккумуляторы могут деградировать, а если сильно перегреть, то даже рвануть.  
Во-вторых, мы должны чем-то их заряжать. Не думаю, что кому-то хочется разбирать корпус и доставать аккумуляторы. Для зарядки опять возьмём что-нибудь "народное", например модуль с микросхемой TP4056 на борту. Там же, кстати, есть и защита, но я решил, что лучше её ставить в самое начало, так что будем использовать выходы Out+/Out-.  

#### Коммутация
Было решено соединить аккумуляторы параллельно, но заряжать каждую своим зарядным устройством. Это выгодно с точки зрения контроля каждой банки, но для нормальной зарядки нам потребуется блок питания 1А*количество_аккумуляторов. То есть 4 ампера. Округлим глаза и забудем про него. Переключать банки будут реле - не важно какие, главное, что при подключении внешнего питания они срабатывают и подключают аккумуляторы к зарядке. Без питания они соединены параллельно.  

#### Работа во время зарядки
В принципе, это реализуемо - надо перекинуть питание 5 вольт с зарядки на изоляторы. Но проблема в том, что каждый канал работает отдельно (надо много реле). К тому же, напряжение питания не ровно 5 вольт, а немного выше. Из-за этого мы получим на выходе вольт 10 или даже больше. 

### Схема и печатная плата

Устройство состоит из двух плат: основной платы с преобразователями/зарядками и платы индикации заряда аккумуляторов.  

#### Основная плата
<div class="thumbnails">
	<li class="tmb">
	<span class="thumbnail" role="button" tabindex="0" style="cursor: pointer;">
      <img src="/img/powerbank/schematic_main_preview.png" alt="/img/powerbank/schematic_main.png" class="img-thumbnail"><br>
	  <center>Основная схема</center>
	</span>
   	</li>
</div>
<br>
В моём варианте схема состоит из пяти одинаковых преобразователей 3.7В -> 5В -> 9В, четырёх аккумуляторов и четырёх зарядок. Всё это коммутируется двумя миниатюрными реле.  
Часть ближе к лицевой панели содержит как раз эти преобразователи. Они специально сделаны узкими (почти в ширину разъёма питания), чтобы можно было легко расположить столько, сколько надо в один ряд. Модули с MT3608 были распаяны и детальки заняли своё место на новой плате.  
Вторая половина содержит зарядки. Я поставил сразу модули, так как для этих микросхем нужен thermalpad. Я пока не в состоянии его сделать. Там же располагаются и реле.  

#### Плата индикации заряда
<div class="thumbnails">
	<li class="tmb">
	<span class="thumbnail" role="button" tabindex="0" style="cursor: pointer;">
      <img src="/img/powerbank/schematic_ind_preview.png" alt="/img/powerbank/schematic_ind.png" class="img-thumbnail"><br>
	  <center>Схема индикатора заряда</center>
	</span>
   	</li>
</div>
<br>
Обычный индикатор на четырёх компараторах. Есть опорное напряжение: в данном случае стабилитрон КС119А на 1.9 вольт - и делитель напряжения на каждый компаратор. Напряжение с аккумуляторов сравнивается с тем, что на делителе и при превышении загорается светодиод. Всё просто.  

### Сборка
Для корпуса я решил взять Gainta G0477 - он металлический и достаточно большой. Как раз половину занимает основная плата, а вторую половину - аккумуляторы (4 шт). Плата индикации встала в свободное пространство между аккумуляторами и задней стенкой.  
Индикация заряда ближе к передней панели, а индикация зарадки - к задней. Их надо припаять к выводу 7 микросхемы через резистор. Достаточно снять штатный светодиод и подпаяться проводками на его место.  
Получилось так, что выходные разъёмы 9 вольт получились утоплены и даже не доставали до корпуса, так что пришлось сверлить отверстия 10 мм, как рад под внешний диаметр штекера. Зато SMD светодиоды снизу платы для индикации питания каждого выхода отлично обрамляли отражённым светом эти отверстия.  
Осталось найти место для разъёма зарядки и выключателя питания.  

### Итог

После сборки устройства обнаружился один косяк. Вернее два.  
1) Некоторые преобразователи не держали напряжение. Решилось тотальной пропайкой/продувкой феном и тщательной промывкой спиртом от флюса - частота-то 1.2Мгц, надо это учитывать. После этим манипуляций всё заработало как надо.  
2) умудрился неправильно поставить стабилитрон. Совсем уже забыл, как с полярностью у отечественных.  

Поставил устройство на зарядку с блоком питания на 2 ампера (от USB разветвителя)/ Где-то за пол-дня или за день (я не обратил внимание) всё зарядилось, светодиоды погасли.  
Насколько его хватит даже не знаю. Подождём - увидим!  

Есть идея сделать mini вариант - только преобразователи-изоляторы B0509 и внешний powerbank. Меня смущает только минимальный стартовый ток повербанка и качество питания. Хотя, последнее можно отфильтровать. И опять проблема с повышенным напряжением питания остаётся открытой.  

### Фото

<div class="fotorama"
	data-nav="thumbs"
	data-allowfullscreen="true"
	data-keyboard="true"
	data-swipe="true"
	data-width="50%"
	data-maxwidth="1280"
    data-maxheight="100%">
	<a href="/img/powerbank/IMG_20181014_234754_414.jpg" data-caption="Плата сверху"><img src="/img/powerbank/IMG_20181014_234754_414_preview.jpg"></a>
	<a href="/img/powerbank/IMG_20181014_234754_418.jpg" data-caption="Плата снизу"><img src="/img/powerbank/IMG_20181014_234754_418_preview.jpg"></a>
	<a href="/img/powerbank/DSC_0005.JPG" data-caption="Внутренности"><img src="/img/powerbank/DSC_0005_preview.JPG"></a>
	<a href="/img/powerbank/DSC_0007.JPG" data-caption="Работает"><img src="/img/powerbank/DSC_0007_preview.JPG"></a>
	<a href="/img/powerbank/DSC_0008.JPG" data-caption="Заряжается"><img src="/img/powerbank/DSC_0008_preview.JPG"></a>
</div>